<html>
    <head>
        <script src="./index.js"></script>
        <script>
            {
                const disable = window.FIGHT_DOM_CLOBBERING({
                    allowlist: ['aaa'],
                    reportOnly: false,
                    // reportTo: 'https://csp-report-server/csp-report/',
                });
                // disable();
            }
        </script>
    </head>
    <body style="max-width: 90vh">
        <h1>DOM Clobbering Protection JavaScript Shim PoC (<a href="https://x.com/WeizmanGal/status/1760394696977789272?s=20">ctx</a>)</h1>
        <div id="aaa">
            <h2> This is <code>DIV#aaa</code> </h2>
            <h4>Since it's in the allowlist, it is allowed to be clobbered</h4>
            <p>This means attempting to access it will return <code>DIV#aaa</code> DOM node</p>
        </div>
        <hr>
        <div id="bbb">
            <h2> This is <code>DIV#bbb</code> </h2>
            <h4>Since it's NOT in the allowlist, it is NOT allowed to be clobbered</h4>
            <p>This means attempting to access it will throw an Error</p>
        </div>
        <hr>
        <div>
            <ul>
                <li>
                    Open the console and try setting the "id" attribute of any DOM node to any value,
                    and then try accessing it via <code>window[YOUR_VALUE]</code> - this will throw an Error as well.
                </li>
                <li>
                    This shim can easily be manifested as a new CSP directive, for example:
                    <ul>
                        <li>
                            <code>Content-Security-Policy: "dom-clobbering: 'aaa'"</code>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <hr>
        <div id="container">
            <script src="./test.js"></script>
            <script>
                {
                    const container = document.getElementById('container');
                    container.innerHTML = '';
                    window.TEST_FIGHT_DOM_CLOBBERING(container);
                }
            </script>
        </div>
        <hr>
        <div>
            <b>Try it yourself: </b>
            <input id="input" placeholder="id:prop123" contenteditable="true"/>
            <i>(<a href="javascript:demo()">access</a> <b style="color:green" id="status">allowed</b>)</i>
            <br><br>
            <textarea id="textarea" placeholder="<div id='prop123'>" style="width: 80%; height: 200px"></textarea>
            <div style="width: 20%; height: 200px; float:left;" id="dump"></div>
            <script>
                {
                    const dump = document.getElementById('dump');
                    const status = document.getElementById('status');
                    const input = document.getElementById('input');
                    const textarea = document.getElementById('textarea');
                    const demo = JSON.parse(localStorage.demo || '{}');
                    const {html, attribute} = demo;
                    attribute && (input.value = attribute);
                    html && (textarea.value = html);
                    window.demo = () => {
                        dump.innerHTML = '';
                        const p = document.createElement('p');
                        const attribute = input.value;
                        const [name, value] = attribute.split(':');
                        const html = textarea.value;
                        if (html || attribute) {
                            if (name !== 'name' && name !== 'id') {
                                return alert('attribute must be "id" or "name" (expected input: "id:xxx" or "name:xxx")');
                            }
                            if (!html) {
                                return alert('html cannot be left empty');
                            }
                        }
                        localStorage.demo = JSON.stringify({html, attribute});
                        p.setAttribute(name, value);
                        dump.appendChild(p);
                        setTimeout(() => {
                            dump.innerHTML += html;
                            setTimeout(() => {
                                try {window[value]} catch {
                                    status.style.color = 'red';
                                    status.innerText = 'blocked';
                                    return;
                                }
                                status.style.color = 'green';
                                status.innerText = 'allowed';
                            });
                        });
                    }
                    window.demo();
                }
            </script>
        </div>
    </body>
</html>
